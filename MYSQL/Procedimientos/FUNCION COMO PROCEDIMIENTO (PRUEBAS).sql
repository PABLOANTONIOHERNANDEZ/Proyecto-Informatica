DROP PROCEDURE IF EXISTS test;
#'45932542P'
#'98725612P', 'PUERTACALLE', NULL, '2020-02-07 12:00:56'
#'98725612P', 'PUERTACALLE', NULL, '2020-02-07 10:00:56'
#'98725612P', '3', '2020-02-07 11:00:56'

DELIMITER $$
CREATE PROCEDURE test()
BEGIN
		DECLARE DNI_AUX varchar(9);
        DECLARE FECHA_ABIERTA_AUX DATETIME;
		DECLARE ALERTA INT DEFAULT 0;
        SET DNI_AUX = '45932542P';
        SET FECHA_ABIERTA_AUX = '2020-02-07 15:00:56';

		SET ALERTA = 
        (
			SELECT TIMESTAMPDIFF
            (
				SECOND,
				(
					SELECT SENSOR_PUERTA_CALLE.FECHA 
					FROM SENSOR_PUERTA_CALLE 
					WHERE SENSOR_PUERTA_CALLE.FECHA = '2020-02-07 10:00:56'
					AND SENSOR_PUERTA_CALLE.DNI_PACIENTE = '98725612P'
					AND SENSOR_PUERTA_CALLE.ABIERTA = TRUE
					ORDER BY SENSOR_PUERTA_CALLE.FECHA ASC
					LIMIT 1
				),
				(
					SELECT SENSOR_PUERTA_CALLE.FECHA 
					FROM SENSOR_PUERTA_CALLE 
					WHERE SENSOR_PUERTA_CALLE.FECHA > '2020-02-07 10:00:56'
					AND SENSOR_PUERTA_CALLE.DNI_PACIENTE = '98725612P'
					AND SENSOR_PUERTA_CALLE.ABIERTA = FALSE
					ORDER BY SENSOR_PUERTA_CALLE.FECHA ASC
					LIMIT 1
				)
			)
		);
        SELECT ALERTA;
END$$

CALL test()